<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mannheim Bid Sheet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .car-form {
      border: 2px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 10px;
    }
    .form-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    input, select {
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    input[readonly] {
      background: #f4f4f4;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      display: inline-block;
    }
  </style>
</head>
<body>

  <h1>Mannheim Bid Sheet</h1>
  <button onclick="sortByLotNumber()">ðŸ”¢ Sort by Lot Number</button>

  <div id="carContainer"></div>
  <button onclick="addCar()">âž• Add Car</button>
  <button onclick="exportToLRH()">ðŸ’¾ Export .lrh</button>
  <input type="file" accept=".lrh" onchange="loadFromLRH(event)">
  

  <script>
    let carIndex = 0;

    function toFixed(val) {
      return isNaN(val) ? "" : parseFloat(val).toFixed(2);
    }

    function addCar(values = {}) {
      const id = carIndex++;
      const container = document.createElement('div');
      container.className = 'car-form';
      container.setAttribute('data-index', id);
      container.innerHTML = `
        <div class="form-group">
          <div><label>Lot Number</label><input type="text" id="lot-${id}" value="${values.lot || ''}"></div>
          <div><label>Registration (VRM)</label><input type="text" id="reg-${id}" value="${values.reg || ''}"></div>
          <div><label>Make</label><input type="text" id="make-${id}" value="${values.make || ''}"></div>
          <div><label>Model</label><input type="text" id="model-${id}" value="${values.model || ''}"></div>
          <div><label>Grade</label><input type="text" id="grade-${id}" value="${values.grade || ''}"></div>
          <div><label>Retail</label><input type="number" id="retail-${id}" value="${values.retail || ''}"></div>
          <div><label>Fees</label><input type="number" id="fees-${id}" value="${values.fees || ''}"></div>
          <div><label>Day to Sell</label><input type="number" id="days-${id}" value="${values.days || ''}"></div>
          <div><label>Ranking</label><input type="text" id="ranking-${id}" value="${values.ranking || ''}"></div>
          <div><label>Max Bid</label><input type="number" id="maxBid-${id}" value="${values.maxBid || ''}"></div>
          <div><label>Sold For</label><input type="number" id="soldFor-${id}" value="${values.soldFor || ''}"></div>
          <div><label>Trade It At</label><input type="number" id="tradeIt-${id}" value="${values.tradeIt || ''}"></div>
          <div><label>Total Prep</label><input type="number" id="totalPrep-${id}" value="${values.tradeIt || ''}"></div>
        </div>

        <div class="form-group">
          
          <div><label>% of Retail</label><input type="text" id="percent-${id}" readonly></div>
          <div><label>Profit for Retailer</label><input type="text" id="profitRetailer-${id}" readonly></div>
          <div><label>Total inc. Fees</label><input type="text" id="totalIncFees-${id}" readonly></div>
          <div><label>Profit Before Fees</label><input type="text" id="profitB4Fees-${id}" readonly></div>
          <div><label>Less Buying Fees</label><input type="text" id="lessFees-${id}" readonly></div>
          <div><label>Total Profit</label><input type="text" id="totalProfit-${id}" readonly></div>
          <div><label>Gross B4 VAT</label><input type="text" id="grossB4-${id}" readonly></div>
          <div><label>Gross Post VAT</label><input type="text" id="grossPost-${id}" readonly></div>
        </div>
      `;
      document.getElementById('carContainer').appendChild(container);

      container.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', () => recalculate(id));
      });
      recalculate(id);
    }

    function recalculate(id) {
      const retail = parseFloat(document.getElementById(`retail-${id}`).value) || 0;
      const fees = parseFloat(document.getElementById(`fees-${id}`).value) || 0;
      const maxBid = parseFloat(document.getElementById(`maxBid-${id}`).value) || 0;
      const soldFor = parseFloat(document.getElementById(`soldFor-${id}`).value) || 0;
      const totalPrep = parseFloat(document.getElementById(`totalPrep-${id}`).value) || 0;

      const percent = retail ? (maxBid / retail) * 100 : 0;
      const profitRetailer = retail - fees - maxBid;
      const totalIncFees = maxBid + fees;
      const profitB4Fees = soldFor - retail;
      const grossB4 = retail - (fees + soldFor);
      const grossPost = grossB4 / 1.2;
      const totalProfit = soldFor ? grossPost - totalPrep : 0;

      document.getElementById(`percent-${id}`).value = toFixed(percent) + "%";
      document.getElementById(`profitRetailer-${id}`).value = "Â£" + toFixed(profitRetailer);
      document.getElementById(`totalIncFees-${id}`).value = "Â£" + toFixed(totalIncFees);
      document.getElementById(`profitB4Fees-${id}`).value = "Â£" + toFixed(profitB4Fees);
      document.getElementById(`lessFees-${id}`).value = "Â£" + toFixed(fees);
      document.getElementById(`totalProfit-${id}`).value = "Â£" + toFixed(totalProfit);
      document.getElementById(`grossB4-${id}`).value = "Â£" + toFixed(grossB4);
      document.getElementById(`grossPost-${id}`).value = "Â£" + toFixed(grossPost);
    }

    function exportToLRH() {
      let data = "";
      for (let i = 0; i < carIndex; i++) {
        const get = id => document.getElementById(`${id}-${i}`)?.value || "";
        if (!document.getElementById(`reg-${i}`)) continue;

        data += `Car ${i + 1}\n`;
        ["lot","reg","make","model","grade","retail","fees","days","ranking","grossB4","grossPost","maxBid","soldFor","tradeIt","percent","profitRetailer","totalIncFees","profitB4Fees","lessFees","totalProfit"].forEach(field => {
          data += `${field}: ${get(field)}\n`;
        });
        data += `----------------------\n\n`;
      }

      const blob = new Blob([data], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "mannheim_bids.lrh";
      a.click();
    }

    function loadFromLRH(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const lines = e.target.result.split(/\r?\n/);
        let car = {};
        lines.forEach(line => {
          if (line.startsWith("Car ")) {
            if (Object.keys(car).length) addCar(car);
            car = {};
          } else if (line.includes(": ")) {
            const [key, ...rest] = line.split(": ");
            car[key.trim()] = rest.join(": ").trim();
          }
        });
        if (Object.keys(car).length) addCar(car);
      };
      reader.readAsText(file);
    }

    function sortByLotNumber() {
      const container = document.getElementById('carContainer');
      const forms = Array.from(container.getElementsByClassName('car-form'));
      forms.sort((a, b) => {
        const aId = a.getAttribute('data-index');
        const bId = b.getAttribute('data-index');
        const aVal = parseInt(document.getElementById(`lot-${aId}`).value) || 0;
        const bVal = parseInt(document.getElementById(`lot-${bId}`).value) || 0;
        return aVal - bVal;
      });
      container.innerHTML = "";
      forms.forEach(f => container.appendChild(f));
    }

    addCar();
  </script>
</body>
</html>
